---
title: "Federal Spending, Political Alignment, and Elections (2020–2024)"
author: "Randy Howk"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)
```

# Purpose and Research Questions

This analysis examines whether changes in federal spending between FY2020 and FY2024:

1. Varied meaningfully across states  
2. Were associated with Biden’s 2020 electoral support  
3. Were associated with 2024 election outcomes for President, Senate, and House  

The analysis is **observational** and evaluates correlation, not causation.

# Libraries

```{r libraries}
library(tidyverse)
library(janitor)
library(lubridate)
library(httr)
library(jsonlite)
library(readxl)
library(scales)
library(ggrepel)
library(usmap)
```

# Minimal-Ink Visualization Theme

```{r theme}
theme_min_ink <- function(base_size = 11, grid = TRUE) {
  theme_classic(base_size = base_size) %+replace%
    theme(
      plot.title.position = "plot",
      plot.title = element_text(margin = margin(b = 6)),
      axis.line = element_line(linewidth = 0.25),
      axis.ticks = element_line(linewidth = 0.25),
      legend.position = "none",
      panel.grid.major = if (grid) element_line(linewidth = 0.25) else element_blank(),
      panel.grid.minor = element_blank()
    )
}
theme_set(theme_min_ink())
```

# Federal Spending Data (USAspending)

```{r usaspending-functions}
usaspending_post <- function(endpoint, body) {
  res <- POST(
    url = paste0("https://api.usaspending.gov", endpoint),
    body = body,
    encode = "json",
    add_headers(`Content-Type` = "application/json")
  )
  stop_for_status(res)
  content(res, as = "parsed", simplifyVector = TRUE)
}

get_state_obligations <- function(fy) {
  body <- list(
    scope = "place_of_performance",
    geo_layer = "state",
    filters = list(
      time_period = list(list(
        start_date = paste0(fy - 1, "-10-01"),
        end_date   = paste0(fy, "-09-30")
      ))
    )
  )

  out <- usaspending_post("/api/v2/search/spending_by_geography/", body)

  tibble(
    state = toupper(out$results$shape_code),
    fiscal_year = fy,
    obligations = out$results$aggregated_amount
  )
}
```

```{r spending-pull}
spending <- purrr::map_dfr(2020:2024, get_state_obligations)
```

# Population Data 

```{r population, message=FALSE}
library(tidyverse)
library(janitor)

# Expected outputs/inputs in your working directory
POP_OUT <- "population_by_state_fy.csv"
CENSUS_IN <- "NST-EST2024-ALLDATA.csv"

if (file.exists(POP_OUT)) {
  pop <- read_csv(POP_OUT, show_col_types = FALSE) |>
    clean_names() |>
    transmute(
      state = toupper(state),
      fiscal_year = as.integer(fiscal_year),
      pop = as.numeric(pop)
    )
} else if (file.exists(CENSUS_IN)) {

  # The Census file often has 2 header lines; readr can handle it with skip=2
  # If your file loads weirdly, change skip to 0 and inspect names(pop_raw)
  pop_raw <- read_csv(CENSUS_IN, skip = 2, show_col_types = FALSE) |>
    clean_names()

  # Expect columns: NAME, POPESTIMATE2020..2024 (exact names after clean_names)
  needed <- c("name", "popestimate2020", "popestimate2021", "popestimate2022",
              "popestimate2023", "popestimate2024")

  missing_cols <- setdiff(needed, names(pop_raw))
  if (length(missing_cols) > 0) {
    stop(
      "NST-EST2024-ALLDATA.csv loaded, but expected columns are missing: ",
      paste(missing_cols, collapse = ", "),
      ". Try adjusting skip=2 to skip=0 and re-knit."
    )
  }

  # Build state abbreviation lookup (50 states + DC)
  state_lu <- tibble(
    name = toupper(state.name),
    state = state.abb
  ) |>
    add_row(name = "DISTRICT OF COLUMBIA", state = "DC")

  pop <- pop_raw |>
    mutate(name = toupper(name)) |>
    inner_join(state_lu, by = "name") |>
    transmute(
      state,
      popestimate2020, popestimate2021, popestimate2022, popestimate2023, popestimate2024
    ) |>
    pivot_longer(
      cols = starts_with("popestimate"),
      names_to = "year",
      values_to = "pop"
    ) |>
    mutate(
      fiscal_year = as.integer(str_extract(year, "\\d{4}")),
      pop = as.numeric(pop)
    ) |>
    select(state, fiscal_year, pop) |>
    arrange(state, fiscal_year)

  write_csv(pop, POP_OUT)
  message("Created ", POP_OUT, " from ", CENSUS_IN)

} else {
  stop(
    "Neither ", POP_OUT, " nor ", CENSUS_IN, " found in the working directory.\n",
    "Put NST-EST2024-ALLDATA.csv in the same folder as the Rmd, or supply population_by_state_fy.csv."
  )
}

# Merge population into spending table
spending_pc <- spending |>
  left_join(pop, by = c("state","fiscal_year")) |>
  mutate(oblig_pc = obligations / pop)
```

# Spending Deltas FY2020–FY2024

```{r spending-delta}
spending_delta <- spending_pc |>
  filter(fiscal_year %in% c(2020, 2024)) |>
  pivot_wider(
    names_from = fiscal_year,
    values_from = c(obligations, oblig_pc),
    names_sep = "_"
  ) |>
  mutate(
    delta_pc = oblig_pc_2024 - oblig_pc_2020
  )
```

# 2024 Election Results

```{r elections-2024}
states_2024 <- read_csv("https://michaelminn.net/tutorials/data/2024-electoral-states.csv") |> clean_names()
districts_2024 <- read_csv("https://michaelminn.net/tutorials/data/2024-electoral-districts.csv") |> clean_names()

pres_2024 <- states_2024 |>
  transmute(
    state = st,
    pres_margin_dem = (votes_dem_2024 - votes_gop_2024) /
      (votes_dem_2024 + votes_gop_2024)
  )

house_2024 <- districts_2024 |>
  group_by(st) |>
  summarize(
    house_margin_dem =
      (sum(votes_dem_2024) - sum(votes_gop_2024)) /
      (sum(votes_dem_2024) + sum(votes_gop_2024)),
    .groups = "drop"
  ) |>
  rename(state = st)

elections_2024 <- left_join(pres_2024, house_2024, by = "state")
```

# Merge Spending and Elections

```{r merge}
analysis <- spending_delta |>
  left_join(elections_2024, by = "state")
```

# Results

## Spending Change vs 2024 Presidential Margin

```{r plot-pres}
ggplot(analysis, aes(delta_pc, pres_margin_dem)) +
  geom_hline(yintercept = 0, linewidth = 0.25) +
  geom_vline(xintercept = 0, linewidth = 0.25) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_continuous(labels = dollar) +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Change in Federal Spending vs 2024 Presidential Margin",
    x = "Δ Federal Obligations per Capita (FY2024 − FY2020)",
    y = "2024 Presidential Margin (Dem − GOP)"
  )
```

## Spending Change vs 2024 House Margin

```{r plot-house}
ggplot(analysis, aes(delta_pc, house_margin_dem)) +
  geom_hline(yintercept = 0, linewidth = 0.25) +
  geom_vline(xintercept = 0, linewidth = 0.25) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_continuous(labels = dollar) +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Change in Federal Spending vs 2024 House Margin",
    x = "Δ Federal Obligations per Capita (FY2024 − FY2020)",
    y = "2024 House Margin (Dem − GOP)"
  )
```

# Exporting Charts to PowerPoint

You have two recommended options:

## Option A — PNG workflow (simple)

1. Knit this document.
2. Right-click figures in the HTML output and save as images.
3. Insert images into PowerPoint using **Insert → Pictures**.

## Option B — Vector PowerPoint workflow (recommended)

Use `officer` + `rvg` to insert charts as editable vectors:

```r
library(officer)
library(rvg)

ppt <- read_pptx()
ppt <- add_slide(ppt, layout = "Title and Content", master = "Office Theme")
ppt <- ph_with(
  ppt,
  dml(ggobj = last_plot()),
  location = ph_location_type(type = "body")
)
print(ppt, target = "spending_elections_2020_2024.pptx")
```

This preserves full resolution and allows text editing directly in PowerPoint.

# Notes

- Results should be interpreted as correlational.
- Spending data are total federal obligations.
- Further robustness checks (e.g., grants-only or agency-specific spending) are encouraged.
